jobs:
  include:
    - stage: test
      language: go
      go: 1.x
      script:
        - cd src/
        - go test -v
    - stage: deploy
      language: go
      go: 1.x
      before_install:
        - curl -sL https://deb.nodesource.com/setup_13.x | sudo -E bash -
        - sudo apt-get install -y nodejs
#        - docker build -f "docker/Dockerfile-build" -t factorio-server-manager docker
      script:
#        - pwd
#        - echo ~
#        - mkdir -p /home/travis/build/mroote/build
#        - docker run -t -e FAC_BRANCH=$TRAVIS_BRANCH -v /home/travis/build/mroote/build:/build factorio-server-manager
#        - cd src/
#        - go test -v
#        - cd ..
        - make gen_release
        - mv factorio-server-manager-linux.zip ~/factorio-server-manager-linux-${TRAVIS_TAG}.zip
        - mv factorio-server-manager-windows.zip ~/factorio-server-manager-windows-${TRAVIS_TAG}.zip
#        - mv /home/travis/build/mroote/build/factorio-server-manager-linux.zip /home/travis/factorio-server-manager-linux-${TRAVIS_TAG}.zip
#        - mv /home/travis/build/mroote/build/factorio-server-manager-windows.zip /home/travis/factorio-server-manager-windows-${TRAVIS_TAG}.zip
      deploy:
        provider: releases
        api_key: "${GITHUB_TOKEN}"
        draft: true
        skip_cleanup: true
        on:
          tags: true
        file:
          - ~/factorio-server-manager-linux-${TRAVIS_TAG}.zip
          - ~/factorio-server-manager-windows-${TRAVIS_TAG}.zip